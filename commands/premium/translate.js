const { SlashCommandBuilder } = require('discord.js');
const ModernComponents = require('../../utils/modernComponents.js');
const axios = require('axios');

module.exports = {
    category: 'Premium',
    data: new SlashCommandBuilder()
        .setName('translate')
        .setDescription('üåê Traduit un texte avec l\'IA / Translate text with AI')
        .setDescriptionLocalizations({
            'en-US': 'üåê Translate text with AI',
            'es-ES': 'üåê Traducir texto con IA'
        })
        .addStringOption(option =>
            option.setName('text')
                .setDescription('Texte √† traduire')
                .setDescriptionLocalizations({
                    'en-US': 'Text to translate',
                    'es-ES': 'Texto a traducir'
                })
                .setRequired(true)
                .setMaxLength(2000)
        )
        .addStringOption(option =>
            option.setName('to')
                .setDescription('Langue de destination')
                .setDescriptionLocalizations({
                    'en-US': 'Target language',
                    'es-ES': 'Idioma de destino'
                })
                .addChoices(
                    { name: 'üá´üá∑ Fran√ßais', value: 'french' },
                    { name: 'üá∫üá∏ English', value: 'english' },
                    { name: 'üá™üá∏ Espa√±ol', value: 'spanish' },
                    { name: 'üá©üá™ Deutsch', value: 'german' },
                    { name: 'üáÆüáπ Italiano', value: 'italian' },
                    { name: 'üáµüáπ Portugu√™s', value: 'portuguese' },
                    { name: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', value: 'russian' },
                    { name: 'üáØüáµ Êó•Êú¨Ë™û', value: 'japanese' },
                    { name: 'üá∞üá∑ ÌïúÍµ≠Ïñ¥', value: 'korean' },
                    { name: 'üá®üá≥ ‰∏≠Êñá', value: 'chinese' },
                    { name: 'üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', value: 'arabic' },
                    { name: 'üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', value: 'hindi' }
                )
                .setRequired(true)
        )
        .addStringOption(option =>
            option.setName('from')
                .setDescription('Langue source (auto-d√©tection si non sp√©cifi√©e)')
                .setDescriptionLocalizations({
                    'en-US': 'Source language (auto-detect if not specified)',
                    'es-ES': 'Idioma de origen (auto-detecci√≥n si no se especifica)'
                })
                .addChoices(
                    { name: 'üîç Auto-d√©tection', value: 'auto' },
                    { name: 'üá´üá∑ Fran√ßais', value: 'french' },
                    { name: 'üá∫üá∏ English', value: 'english' },
                    { name: 'üá™üá∏ Espa√±ol', value: 'spanish' },
                    { name: 'üá©üá™ Deutsch', value: 'german' },
                    { name: 'üáÆüáπ Italiano', value: 'italian' },
                    { name: 'üáµüáπ Portugu√™s', value: 'portuguese' },
                    { name: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', value: 'russian' },
                    { name: 'üáØüáµ Êó•Êú¨Ë™û', value: 'japanese' },
                    { name: 'üá∞üá∑ ÌïúÍµ≠Ïñ¥', value: 'korean' },
                    { name: 'üá®üá≥ ‰∏≠Êñá', value: 'chinese' },
                    { name: 'üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', value: 'arabic' },
                    { name: 'üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', value: 'hindi' }
                )
                .setRequired(false)
        )
        .addStringOption(option =>
            option.setName('style')
                .setDescription('Style de traduction')
                .setDescriptionLocalizations({
                    'en-US': 'Translation style',
                    'es-ES': 'Estilo de traducci√≥n'
                })
                .addChoices(
                    { name: 'üìù Standard', value: 'standard' },
                    { name: 'üé© Formel', value: 'formal' },
                    { name: 'üòä D√©contract√©', value: 'casual' },
                    { name: 'üìö Litt√©raire', value: 'literary' },
                    { name: 'üíº Professionnel', value: 'professional' },
                    { name: 'üé≠ Cr√©atif', value: 'creative' }
                )
                .setRequired(false)
        )
        .addBooleanOption(option =>
            option.setName('private')
                .setDescription('Traduction visible uniquement par vous')
                .setDescriptionLocalizations({
                    'en-US': 'Translation visible only to you',
                    'es-ES': 'Traducci√≥n visible solo para ti'
                })
                .setRequired(false)
        ),
    
    async execute(interaction, client, getTranslation) {
        const text = interaction.options.getString('text');
        const targetLang = interaction.options.getString('to');
        const sourceLang = interaction.options.getString('from') || 'auto';
        const style = interaction.options.getString('style') || 'standard';
        const isPrivate = interaction.options.getBoolean('private') || false;
        
        // V√©rifier si les fonctionnalit√©s IA sont activ√©es
        if (!process.env.OPENAI_API_KEY) {
            const errorMessage = ModernComponents.createErrorMessage({
                title: '‚ùå Traduction IA d√©sactiv√©e',
                description: 'La traduction par IA n\'est pas configur√©e sur ce bot.',
                fields: [
                    {
                        name: 'üí° Information',
                        value: 'Contactez l\'administrateur du bot pour activer cette fonctionnalit√©.'
                    }
                ]
            });
            
            return await interaction.editReply(errorMessage);
        }
        
        // Mappage des langues
        const languageMap = {
            french: 'fran√ßais',
            english: 'anglais',
            spanish: 'espagnol',
            german: 'allemand',
            italian: 'italien',
            portuguese: 'portugais',
            russian: 'russe',
            japanese: 'japonais',
            korean: 'cor√©en',
            chinese: 'chinois',
            arabic: 'arabe',
            hindi: 'hindi'
        };
        
        // Mappage des styles
        const styleMap = {
            standard: 'de mani√®re standard et naturelle',
            formal: 'de mani√®re formelle et respectueuse',
            casual: 'de mani√®re d√©contract√©e et famili√®re',
            literary: 'avec un style litt√©raire et √©l√©gant',
            professional: 'avec un ton professionnel et technique',
            creative: 'avec cr√©ativit√© et expressivit√©'
        };
        
        // Cr√©er le message de chargement
        const loadingMessage = ModernComponents.createInfoMessage({
            title: 'üåê Traduction en cours...',
            description: `**Texte:** ${text.substring(0, 100)}${text.length > 100 ? '...' : ''}\n**De:** ${sourceLang === 'auto' ? 'üîç Auto-d√©tection' : languageMap[sourceLang]}\n**Vers:** ${languageMap[targetLang]}\n**Style:** ${style}`,
            fields: [
                {
                    name: '‚è≥ Statut',
                    value: 'üîÑ L\'IA traduit votre texte...'
                }
            ],
            color: '#4dabf7'
        });
        
        await interaction.editReply(loadingMessage);
        
        try {
            const startTime = Date.now();
            
            // Construire le prompt de traduction
            let prompt;
            if (sourceLang === 'auto') {
                prompt = `Traduis le texte suivant en ${languageMap[targetLang]} ${styleMap[style]}. D√©tecte automatiquement la langue source et fournis une traduction pr√©cise et naturelle :\n\n"${text}"`;
            } else {
                prompt = `Traduis le texte suivant du ${languageMap[sourceLang]} vers le ${languageMap[targetLang]} ${styleMap[style]}. Fournis une traduction pr√©cise et naturelle :\n\n"${text}"`;
            }
            
            // Mapper les langues vers les codes ISO pour Hugging Face
            const langCodeMap = {
                'french': 'fr',
                'english': 'en',
                'spanish': 'es',
                'german': 'de',
                'italian': 'it',
                'portuguese': 'pt',
                'russian': 'ru',
                'japanese': 'ja',
                'korean': 'ko',
                'chinese': 'zh',
                'arabic': 'ar',
                'hindi': 'hi'
            };
            
            const targetCode = langCodeMap[targetLang];
            
            // Utiliser LibreTranslate (API gratuite et open source)
            const response = await axios.post(
                'https://libretranslate.de/translate',
                {
                    q: text,
                    source: sourceLang === 'auto' ? 'auto' : langCodeMap[sourceLang] || 'en',
                    target: targetCode,
                    format: 'text'
                },
                {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    timeout: 30000
                }
            );
            
            const translation = response.data.translatedText || text;
            const endTime = Date.now();
            const translationTime = endTime - startTime;
            
            // D√©tecter la langue source si auto-d√©tection
            let detectedLang = sourceLang;
            if (sourceLang === 'auto') {
                // Demander √† l'IA de d√©tecter la langue
                try {
                    const detectResponse = await axios.post('https://api.openai.com/v1/chat/completions', {
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'user',
                                content: `D√©tecte la langue de ce texte et r√©ponds uniquement par le nom de la langue en fran√ßais : "${text.substring(0, 200)}"`
                            }
                        ],
                        max_tokens: 50,
                        temperature: 0
                    }, {
                        headers: {
                            'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        timeout: 10000
                    });
                    
                    detectedLang = response.data.choices[0].message.content.toLowerCase().trim();
                } catch (error) {
                    detectedLang = 'Langue d√©tect√©e';
                }
            }
            
            // Diviser la traduction si elle est trop longue
            const chunks = ModernComponents.splitLongText(translation, 1800);
            
            // Cr√©er le message de succ√®s
            const successMessage = ModernComponents.createSuccessMessage({
                title: 'üåê Traduction termin√©e !',
                description: `**Langue source:** ${sourceLang === 'auto' ? `üîç ${detectedLang}` : languageMap[sourceLang]}\n**Langue cible:** ${languageMap[targetLang]}\n**Style:** ${style} ‚Ä¢ **Temps:** ${translationTime}ms`,
                fields: [
                    {
                        name: 'üìù Texte original',
                        value: `\`\`\`${text.substring(0, 500)}${text.length > 500 ? '...' : ''}\`\`\``
                    },
                    {
                        name: 'üåê Traduction',
                        value: chunks[0]
                    }
                ],
                buttons: [
                    {
                        customId: `translate_reverse_${Date.now()}`,
                        label: 'üîÑ Traduction inverse',
                        style: 2
                    },
                    {
                        customId: `translate_alternative_${Date.now()}`,
                        label: 'üé≤ Alternative',
                        style: 1
                    },
                    {
                        customId: `translate_explain_${Date.now()}`,
                        label: 'üí° Expliquer',
                        style: 2
                    }
                ]
            });
            
            await interaction.editReply(successMessage);
            
            // Envoyer les chunks suppl√©mentaires si n√©cessaire
            if (chunks.length > 1) {
                for (let i = 1; i < chunks.length; i++) {
                    const followUpMessage = ModernComponents.createContainer({
                        components: [
                            ModernComponents.createTextDisplay({
                                content: `**Suite de la traduction:**\n${chunks[i]}`,
                                style: 'paragraph'
                            })
                        ]
                    });
                    
                    await interaction.followUp({ ...followUpMessage, ephemeral: isPrivate });
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de la traduction:', error);
            
            let errorTitle = '‚ùå Erreur de traduction';
            let errorDescription = 'Une erreur est survenue lors de la traduction.';
            
            if (error.response) {
                if (error.response.status === 401) {
                    errorTitle = 'üîë Erreur d\'authentification';
                    errorDescription = 'Cl√© API invalide ou expir√©e.';
                } else if (error.response.status === 429) {
                    errorTitle = '‚è∞ Limite de taux atteinte';
                    errorDescription = 'Trop de requ√™tes. Veuillez r√©essayer dans quelques minutes.';
                } else if (error.response.status === 500) {
                    errorTitle = 'üîß Erreur du serveur IA';
                    errorDescription = 'Le service de traduction rencontre des difficult√©s techniques.';
                }
            } else if (error.code === 'ECONNABORTED') {
                errorTitle = '‚è±Ô∏è Timeout';
                errorDescription = 'La traduction a pris trop de temps. Veuillez r√©essayer.';
            }
            
            const errorMessage = ModernComponents.createErrorMessage({
                title: errorTitle,
                description: errorDescription,
                fields: [
                    {
                        name: 'üîß D√©tails techniques',
                        value: `**Langues:** ${sourceLang} ‚Üí ${targetLang}\n**Style:** ${style}\n**Erreur:** ${error.message || 'Erreur inconnue'}`
                    },
                    {
                        name: 'üí° Solutions',
                        value: '‚Ä¢ V√©rifiez que le texte est dans la bonne langue\n‚Ä¢ Essayez un style diff√©rent\n‚Ä¢ R√©essayez dans quelques minutes'
                    }
                ],
                buttons: [
                    {
                        customId: `translate_retry_${Date.now()}`,
                        label: 'üîÑ R√©essayer',
                        style: 2
                    }
                ]
            });
            
            await interaction.editReply(errorMessage);
        }
    }
};