const { SlashCommandBuilder } = require('discord.js');
const ModernComponents = require('../../utils/modernComponents.js');
const axios = require('axios');

module.exports = {
    category: 'Premium',
    data: new SlashCommandBuilder()
        .setName('analyze')
        .setDescription('üîç Analyse du contenu avec l\'IA / Analyze content with AI')
        .setDescriptionLocalizations({
            'en-US': 'üîç Analyze content with AI',
            'es-ES': 'üîç Analizar contenido con IA'
        })
        .addSubcommand(subcommand =>
            subcommand
                .setName('text')
                .setDescription('üìù Analyser un texte')
                .setDescriptionLocalizations({
                    'en-US': 'üìù Analyze text',
                    'es-ES': 'üìù Analizar texto'
                })
                .addStringOption(option =>
                    option.setName('content')
                        .setDescription('Texte √† analyser')
                        .setDescriptionLocalizations({
                            'en-US': 'Text to analyze',
                            'es-ES': 'Texto a analizar'
                        })
                        .setRequired(true)
                        .setMaxLength(3000)
                )
                .addStringOption(option =>
                    option.setName('type')
                        .setDescription('Type d\'analyse')
                        .setDescriptionLocalizations({
                            'en-US': 'Analysis type',
                            'es-ES': 'Tipo de an√°lisis'
                        })
                        .addChoices(
                            { name: 'üìä Analyse g√©n√©rale', value: 'general' },
                            { name: 'üòä Sentiment', value: 'sentiment' },
                            { name: 'üéØ Mots-cl√©s', value: 'keywords' },
                            { name: 'üìö Style d\'√©criture', value: 'style' },
                            { name: 'üîç R√©sum√©', value: 'summary' },
                            { name: 'üåê Langue et grammaire', value: 'grammar' },
                            { name: 'üíº Ton professionnel', value: 'professional' }
                        )
                        .setRequired(false)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('image')
                .setDescription('üñºÔ∏è Analyser une image')
                .setDescriptionLocalizations({
                    'en-US': 'üñºÔ∏è Analyze image',
                    'es-ES': 'üñºÔ∏è Analizar imagen'
                })
                .addAttachmentOption(option =>
                    option.setName('image')
                        .setDescription('Image √† analyser')
                        .setDescriptionLocalizations({
                            'en-US': 'Image to analyze',
                            'es-ES': 'Imagen a analizar'
                        })
                        .setRequired(true)
                )
                .addStringOption(option =>
                    option.setName('focus')
                        .setDescription('Focus de l\'analyse')
                        .setDescriptionLocalizations({
                            'en-US': 'Analysis focus',
                            'es-ES': 'Enfoque del an√°lisis'
                        })
                        .addChoices(
                            { name: 'üîç Description g√©n√©rale', value: 'general' },
                            { name: 'üë• Personnes', value: 'people' },
                            { name: 'üèûÔ∏è Paysage/Lieu', value: 'landscape' },
                            { name: 'üé® Style artistique', value: 'artistic' },
                            { name: 'üìù Texte dans l\'image', value: 'text' },
                            { name: 'üè∑Ô∏è Objets', value: 'objects' },
                            { name: 'üé≠ √âmotions', value: 'emotions' }
                        )
                        .setRequired(false)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('url')
                .setDescription('üîó Analyser une page web')
                .setDescriptionLocalizations({
                    'en-US': 'üîó Analyze web page',
                    'es-ES': 'üîó Analizar p√°gina web'
                })
                .addStringOption(option =>
                    option.setName('url')
                        .setDescription('URL √† analyser')
                        .setDescriptionLocalizations({
                            'en-US': 'URL to analyze',
                            'es-ES': 'URL a analizar'
                        })
                        .setRequired(true)
                )
                .addStringOption(option =>
                    option.setName('aspect')
                        .setDescription('Aspect √† analyser')
                        .setDescriptionLocalizations({
                            'en-US': 'Aspect to analyze',
                            'es-ES': 'Aspecto a analizar'
                        })
                        .addChoices(
                            { name: 'üìÑ Contenu principal', value: 'content' },
                            { name: 'üé® Design/UX', value: 'design' },
                            { name: 'üîç SEO', value: 'seo' },
                            { name: '‚ö° Performance', value: 'performance' },
                            { name: 'üõ°Ô∏è S√©curit√©', value: 'security' },
                            { name: 'üìä Analyse compl√®te', value: 'complete' }
                        )
                        .setRequired(false)
                )
        ),
    
    async execute(interaction, client, getTranslation) {
        const subcommand = interaction.options.getSubcommand();
        
        // V√©rifier si les fonctionnalit√©s IA sont activ√©es
        if (!process.env.OPENAI_API_KEY) {
            const errorMessage = ModernComponents.createErrorMessage({
                title: '‚ùå Analyse IA d√©sactiv√©e',
                description: 'L\'analyse par IA n\'est pas configur√©e sur ce bot.',
                fields: [
                    {
                        name: 'üí° Information',
                        value: 'Contactez l\'administrateur du bot pour activer cette fonctionnalit√©.'
                    }
                ]
            });
            
            return await interaction.editReply(errorMessage);
        }
        
        if (subcommand === 'text') {
            await this.analyzeText(interaction);
        } else if (subcommand === 'image') {
            await this.analyzeImage(interaction);
        } else if (subcommand === 'url') {
            await this.analyzeUrl(interaction);
        }
    },
    
    async analyzeText(interaction) {
        const content = interaction.options.getString('content');
        const analysisType = interaction.options.getString('type') || 'general';
        
        // Prompts pour diff√©rents types d'analyse
        const analysisPrompts = {
            general: 'Fais une analyse compl√®te de ce texte : style, ton, structure, th√®mes principaux, et qualit√© g√©n√©rale.',
            sentiment: 'Analyse le sentiment de ce texte : √©motions exprim√©es, ton g√©n√©ral (positif/n√©gatif/neutre), et nuances √©motionnelles.',
            keywords: 'Extrais et analyse les mots-cl√©s principaux de ce texte, leur fr√©quence et leur importance contextuelle.',
            style: 'Analyse le style d\'√©criture de ce texte : registre de langue, figures de style, structure des phrases, et techniques litt√©raires.',
            summary: 'Fais un r√©sum√© d√©taill√© de ce texte en identifiant les points cl√©s et les id√©es principales.',
            grammar: 'Analyse la langue et la grammaire de ce texte : correction linguistique, structure, et suggestions d\'am√©lioration.',
            professional: '√âvalue le ton professionnel de ce texte et sugg√®re des am√©liorations pour un contexte business.'
        };
        
        const loadingMessage = ModernComponents.createInfoMessage({
            title: 'üîç Analyse en cours...',
            description: `**Type:** ${analysisType}\n**Longueur:** ${content.length} caract√®res`,
            fields: [
                {
                    name: 'üìù Extrait du texte',
                    value: `\`\`\`${content.substring(0, 200)}${content.length > 200 ? '...' : ''}\`\`\``
                }
            ],
            color: '#9c88ff'
        });
        
        await interaction.editReply(loadingMessage);
        
        try {
            const startTime = Date.now();
            
            const response = await axios.post('https://api.openai.com/v1/chat/completions', {
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: 'Tu es un expert en analyse textuelle. Tu fournis des analyses d√©taill√©es, structur√©es et pertinentes.'
                    },
                    {
                        role: 'user',
                        content: `${analysisPrompts[analysisType]}\n\nTexte √† analyser :\n"${content}"`
                    }
                ],
                max_tokens: 2000,
                temperature: 0.3
            }, {
                headers: {
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                timeout: 30000
            });
            
            const analysis = response.data.choices[0].message.content;
            const endTime = Date.now();
            const analysisTime = endTime - startTime;
            
            const chunks = ModernComponents.splitLongText(analysis, 1800);
            
            const successMessage = ModernComponents.createSuccessMessage({
                title: 'üîç Analyse textuelle termin√©e',
                description: `**Type d\'analyse:** ${analysisType}\n**Temps:** ${analysisTime}ms\n**Longueur:** ${content.length} caract√®res`,
                fields: [
                    {
                        name: 'üìä R√©sultats de l\'analyse',
                        value: chunks[0]
                    }
                ],
                buttons: [
                    {
                        customId: `analyze_rerun_${Date.now()}`,
                        label: 'üîÑ Autre analyse',
                        style: 2
                    },
                    {
                        customId: `analyze_detailed_${Date.now()}`,
                        label: 'üîç Plus de d√©tails',
                        style: 1
                    }
                ]
            });
            
            await interaction.editReply(successMessage);
            
            // Envoyer les chunks suppl√©mentaires
            if (chunks.length > 1) {
                for (let i = 1; i < chunks.length; i++) {
                    const followUpMessage = ModernComponents.createContainer({
                        components: [
                            ModernComponents.createTextDisplay({
                                content: `**Suite de l\'analyse:**\n${chunks[i]}`,
                                style: 'paragraph'
                            })
                        ]
                    });
                    
                    await interaction.followUp(followUpMessage);
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de l\'analyse de texte:', error);
            await this.handleAnalysisError(interaction, error, 'texte');
        }
    },
    
    async analyzeImage(interaction) {
        const imageAttachment = interaction.options.getAttachment('image');
        const focus = interaction.options.getString('focus') || 'general';
        
        // V√©rifier que c'est bien une image
        if (!imageAttachment.contentType || !imageAttachment.contentType.startsWith('image/')) {
            const errorMessage = ModernComponents.createErrorMessage({
                title: '‚ùå Fichier invalide',
                description: 'Le fichier fourni n\'est pas une image valide.',
                fields: [
                    {
                        name: 'üìã Formats support√©s',
                        value: 'PNG, JPG, JPEG, GIF, WEBP'
                    }
                ]
            });
            
            return await interaction.editReply(errorMessage);
        }
        
        const loadingMessage = ModernComponents.createInfoMessage({
            title: 'üñºÔ∏è Analyse d\'image en cours...',
            description: `**Focus:** ${focus}\n**Taille:** ${(imageAttachment.size / 1024).toFixed(1)} KB`,
            fields: [
                {
                    name: '‚è≥ Statut',
                    value: 'üîÑ L\'IA analyse votre image...'
                }
            ],
            color: '#ff6b9d',
            thumbnail: imageAttachment.url
        });
        
        await interaction.editReply(loadingMessage);
        
        try {
            const startTime = Date.now();
            
            // Prompts selon le focus
            const focusPrompts = {
                general: 'D√©cris cette image en d√©tail : ce que tu vois, les couleurs, la composition, l\'ambiance g√©n√©rale.',
                people: 'Analyse les personnes dans cette image : nombre, √¢ge approximatif, expressions, postures, v√™tements.',
                landscape: 'D√©cris le paysage ou le lieu : environnement, architecture, √©l√©ments naturels, atmosph√®re.',
                artistic: 'Analyse le style artistique : technique, composition, couleurs, style, √©poque possible.',
                text: 'Identifie et transcris tout texte visible dans cette image.',
                objects: 'Identifie et d√©cris tous les objets visibles dans cette image.',
                emotions: 'Analyse les √©motions et l\'ambiance transmises par cette image.'
            };
            
            const response = await axios.post('https://api.openai.com/v1/chat/completions', {
                model: 'gpt-4o-mini',
                messages: [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: focusPrompts[focus]
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageAttachment.url,
                                    detail: 'high'
                                }
                            }
                        ]
                    }
                ],
                max_tokens: 2000
            }, {
                headers: {
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                timeout: 45000
            });
            
            const analysis = response.data.choices[0].message.content;
            const endTime = Date.now();
            const analysisTime = endTime - startTime;
            
            const chunks = ModernComponents.splitLongText(analysis, 1800);
            
            const successMessage = ModernComponents.createSuccessMessage({
                title: 'üñºÔ∏è Analyse d\'image termin√©e',
                description: `**Focus:** ${focus}\n**Temps:** ${analysisTime}ms\n**Mod√®le:** GPT-4o Mini`,
                fields: [
                    {
                        name: 'üîç Analyse visuelle',
                        value: chunks[0]
                    }
                ],
                image: imageAttachment.url,
                buttons: [
                    {
                        customId: `analyze_image_focus_${Date.now()}`,
                        label: 'üéØ Autre focus',
                        style: 2
                    },
                    {
                        customId: `analyze_image_detailed_${Date.now()}`,
                        label: 'üîç Plus de d√©tails',
                        style: 1
                    }
                ]
            });
            
            await interaction.editReply(successMessage);
            
            // Envoyer les chunks suppl√©mentaires
            if (chunks.length > 1) {
                for (let i = 1; i < chunks.length; i++) {
                    const followUpMessage = ModernComponents.createContainer({
                        components: [
                            ModernComponents.createTextDisplay({
                                content: `**Suite de l\'analyse:**\n${chunks[i]}`,
                                style: 'paragraph'
                            })
                        ]
                    });
                    
                    await interaction.followUp(followUpMessage);
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de l\'analyse d\'image:', error);
            await this.handleAnalysisError(interaction, error, 'image');
        }
    },
    
    async analyzeUrl(interaction) {
        const url = interaction.options.getString('url');
        const aspect = interaction.options.getString('aspect') || 'content';
        
        // Valider l'URL
        try {
            new URL(url);
        } catch {
            const errorMessage = ModernComponents.createErrorMessage({
                title: '‚ùå URL invalide',
                description: 'L\'URL fournie n\'est pas valide.',
                fields: [
                    {
                        name: 'üí° Format attendu',
                        value: 'https://exemple.com ou http://exemple.com'
                    }
                ]
            });
            
            return await interaction.editReply(errorMessage);
        }
        
        const loadingMessage = ModernComponents.createInfoMessage({
            title: 'üîó Analyse d\'URL en cours...',
            description: `**URL:** ${url}\n**Aspect:** ${aspect}`,
            fields: [
                {
                    name: '‚è≥ Statut',
                    value: 'üîÑ R√©cup√©ration et analyse du contenu...'
                }
            ],
            color: '#4ecdc4'
        });
        
        await interaction.editReply(loadingMessage);
        
        try {
            // Note: Pour une vraie impl√©mentation, vous devriez utiliser un service de scraping
            // Ici, nous simulons l'analyse avec l'IA
            const startTime = Date.now();
            
            const aspectPrompts = {
                content: `Analyse le contenu principal de cette page web : ${url}. D√©cris le sujet, la structure, la qualit√© du contenu.`,
                design: `Analyse le design et l'UX de cette page web : ${url}. √âvalue l'interface, la navigation, l'esth√©tique.`,
                seo: `Analyse le SEO de cette page web : ${url}. √âvalue l'optimisation pour les moteurs de recherche.`,
                performance: `Analyse les performances de cette page web : ${url}. √âvalue la vitesse, l'optimisation.`,
                security: `Analyse la s√©curit√© de cette page web : ${url}. √âvalue les aspects de s√©curit√© visibles.`,
                complete: `Fais une analyse compl√®te de cette page web : ${url}. Couvre le contenu, design, SEO, et aspects techniques.`
            };
            
            const response = await axios.post('https://api.openai.com/v1/chat/completions', {
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: 'Tu es un expert en analyse web. Tu fournis des analyses d√©taill√©es des sites web bas√©es sur les meilleures pratiques.'
                    },
                    {
                        role: 'user',
                        content: aspectPrompts[aspect]
                    }
                ],
                max_tokens: 2000,
                temperature: 0.3
            }, {
                headers: {
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                timeout: 30000
            });
            
            const analysis = response.data.choices[0].message.content;
            const endTime = Date.now();
            const analysisTime = endTime - startTime;
            
            const chunks = ModernComponents.splitLongText(analysis, 1800);
            
            const successMessage = ModernComponents.createSuccessMessage({
                title: 'üîó Analyse d\'URL termin√©e',
                description: `**URL:** ${url}\n**Aspect:** ${aspect}\n**Temps:** ${analysisTime}ms`,
                fields: [
                    {
                        name: 'üåê Analyse web',
                        value: chunks[0]
                    }
                ],
                buttons: [
                    {
                        customId: `analyze_url_aspect_${Date.now()}`,
                        label: 'üéØ Autre aspect',
                        style: 2
                    },
                    {
                        customId: `analyze_url_visit_${Date.now()}`,
                        label: 'üîó Visiter',
                        style: 5,
                        url: url
                    }
                ]
            });
            
            await interaction.editReply(successMessage);
            
            // Envoyer les chunks suppl√©mentaires
            if (chunks.length > 1) {
                for (let i = 1; i < chunks.length; i++) {
                    const followUpMessage = ModernComponents.createContainer({
                        components: [
                            ModernComponents.createTextDisplay({
                                content: `**Suite de l\'analyse:**\n${chunks[i]}`,
                                style: 'paragraph'
                            })
                        ]
                    });
                    
                    await interaction.followUp(followUpMessage);
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de l\'analyse d\'URL:', error);
            await this.handleAnalysisError(interaction, error, 'URL');
        }
    },
    
    async handleAnalysisError(interaction, error, type) {
        let errorTitle = `‚ùå Erreur d\'analyse ${type}`;
        let errorDescription = `Une erreur est survenue lors de l\'analyse ${type === 'URL' ? 'de l\'URL' : type === 'image' ? 'de l\'image' : 'du texte'}.`;
        
        if (error.response) {
            if (error.response.status === 401) {
                errorTitle = 'üîë Erreur d\'authentification';
                errorDescription = 'Cl√© API invalide ou expir√©e.';
            } else if (error.response.status === 429) {
                errorTitle = '‚è∞ Limite de taux atteinte';
                errorDescription = 'Trop de requ√™tes. Veuillez r√©essayer dans quelques minutes.';
            } else if (error.response.status === 400) {
                errorTitle = '‚ö†Ô∏è Contenu non analysable';
                errorDescription = 'Le contenu fourni ne peut pas √™tre analys√©.';
            }
        }
        
        const errorMessage = ModernComponents.createErrorMessage({
            title: errorTitle,
            description: errorDescription,
            fields: [
                {
                    name: 'üîß D√©tails techniques',
                    value: `**Type:** ${type}\n**Erreur:** ${error.message || 'Erreur inconnue'}`
                },
                {
                    name: 'üí° Solutions',
                    value: '‚Ä¢ V√©rifiez le contenu fourni\n‚Ä¢ R√©essayez dans quelques minutes\n‚Ä¢ Contactez le support si le probl√®me persiste'
                }
            ],
            buttons: [
                {
                    customId: `analyze_retry_${Date.now()}`,
                    label: 'üîÑ R√©essayer',
                    style: 2
                }
            ]
        });
        
        await interaction.editReply(errorMessage);
    }
};